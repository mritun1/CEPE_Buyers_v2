<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Dashboard</title>

<!-- React + Babel -->
<script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- TradingView -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;
const { createRoot } = ReactDOM;

function TradingDashboard() {
  const [marketStatus, setMarketStatus] = useState('Checking...');
  const [summary, setSummary] = useState({ day_pnl: 0, capital_used: 0, return_pct: 0 });
  const [trades, setTrades] = useState([]);
  const [logs, setLogs] = useState([]);
  const [wsConnected, setWsConnected] = useState(false);
  const logContainerRef = useRef(null);
  const tvWidgetRef = useRef(null);

  // Initialize TradingView
  useEffect(() => {
    setTimeout(() => {
      tvWidgetRef.current = new TradingView.widget({
        container_id: "tradingview_chart",
        width: "100%",
        height: 500,
        symbol: "NSE:BANKNIFTY",
        interval: "1",
        timezone: "Asia/Kolkata",
        theme: "light",
        style: 1,
        locale: "en",
        toolbar_bg: "#f1f3f6",
        hide_side_toolbar: false,
        allow_symbol_change: true,
        studies: [],
        withdateranges: true,
        enable_publishing: false,
        save_image: false,
        details: true,
        hotlist: true,
        calendar: true,
      });
    }, 500);
  }, []);

  // WebSocket
  useEffect(() => {
    let ws;
    const connectWebSocket = () => {
      ws = new WebSocket('ws://localhost:8765');
      ws.onopen = () => setWsConnected(true);
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if(data.type === 'log') {
            setLogs(prev => [...prev, {id: Date.now(), message: data.data}].slice(-50));
            if(data.data.includes("Market status")) {
              setMarketStatus(data.data.includes("Open") ? "Open" : "Closed");
            }
          } else if(data.type === 'trades') setTrades(data.data);
          else if(data.type === 'summary') setSummary(data.data);
        } catch(e) { console.error("WS parse error:", e); }
      };
      ws.onclose = () => { setWsConnected(false); setTimeout(connectWebSocket, 5000); };
      ws.onerror = () => setWsConnected(false);
    };
    connectWebSocket();
    return () => ws && ws.close();
  }, []);

  // Polling fallback for logs/trades/summary if WS fails
  useEffect(() => {
    const pollData = async () => {
      try {
        const [logsRes, tradesRes, summaryRes] = await Promise.all([
          fetch('http://localhost:5000/api/logs').then(r=>r.json()),
          fetch('http://localhost:5000/api/trades').then(r=>r.json()),
          fetch('http://localhost:5000/api/summary').then(r=>r.json())
        ]);
        setLogs(logsRes.map((l,i)=>({id:i,message:l.message})));
        setTrades(tradesRes);
        setSummary(summaryRes);
        const marketLog = logsRes.find(l=>l.message.includes('Market status'));
        if(marketLog) setMarketStatus(marketLog.message.includes('Open')?"Open":"Closed");
      } catch(e) { console.error("Polling error:", e); }
    };
    const interval = setInterval(()=>{ if(!wsConnected) pollData(); },2000);
    return ()=>clearInterval(interval);
  }, [wsConnected]);

  // Auto-scroll logs
  useEffect(()=>{
    if(logContainerRef.current) logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;
  }, [logs]);

  return (
    <div className="min-h-screen flex flex-col">
      {/* Navbar */}
      <nav className="bg-gray-800 text-white p-4 flex justify-between items-center">
        <h1 className="text-xl font-bold">Trading Dashboard {wsConnected ? 'ðŸŸ¢' : 'ðŸ”´'} (Market: {marketStatus})</h1>
        <div className="flex space-x-6">
          <div>Day P&L: â‚¹{summary.day_pnl.toFixed(2)}</div>
          <div>Capital Used: â‚¹{summary.capital_used.toFixed(2)}</div>
          <div>Net Return: {summary.return_pct.toFixed(2)}%</div>
        </div>
      </nav>

      {/* Main content */}
      <div className="flex flex-col md:flex-row p-4 space-y-4 md:space-y-0 md:space-x-4">
        <div className="flex-1 bg-white rounded-lg shadow-md p-4">
          <div id="tradingview_chart" style={{height:'500px', width:'100%'}}></div>
        </div>
        <div className="w-64 flex flex-col space-y-4">
          <button className="bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded">Buy CE</button>
          <button className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded">Buy PE</button>
        </div>
      </div>

      <div className="flex flex-col md:flex-row p-4 space-y-4 md:space-y-0 md:space-x-4 flex-1">
        {/* Trade History */}
        <div className="flex-1 bg-white rounded-lg shadow-md p-4 overflow-x-auto">
          <h2 className="text-lg font-semibold mb-2">Trade History</h2>
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-gray-200">
                <th className="p-2">Time</th>
                <th className="p-2">Action</th>
                <th className="p-2">Instrument</th>
                <th className="p-2">Qty</th>
                <th className="p-2">Price</th>
                <th className="p-2">Gross P&L</th>
                <th className="p-2">Net P&L</th>
                <th className="p-2">Day P&L</th>
              </tr>
            </thead>
            <tbody>
              {trades.length===0 ? <tr><td colSpan="8" className="p-2 text-center">No trades available</td></tr> :
              trades.map(trade => (
                <tr key={trade.timestamp} className="border-t">
                  <td className="p-2">{new Date(trade.timestamp).toLocaleString()}</td>
                  <td className="p-2">{trade.action}</td>
                  <td className="p-2">{trade.instrument_key}</td>
                  <td className="p-2">{trade.quantity}</td>
                  <td className="p-2">â‚¹{trade.price.toFixed(2)}</td>
                  <td className="p-2">{trade.gross_profit?`â‚¹${trade.gross_profit.toFixed(2)}`:'-'}</td>
                  <td className="p-2">{trade.net_profit?`â‚¹${trade.net_profit.toFixed(2)}`:'-'}</td>
                  <td className="p-2">{trade.day_pnl?`â‚¹${trade.day_pnl.toFixed(2)}`:'-'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Logs */}
        <div className="w-80 bg-white rounded-lg shadow-md p-4 flex flex-col">
          <h2 className="text-lg font-semibold mb-2">Logs</h2>
          <div ref={logContainerRef} className="flex-1 overflow-y-auto bg-gray-900 text-white p-2 rounded font-mono text-sm">
            {logs.length===0 ? <div>No logs</div> : logs.map(log => <div key={log.id}>{log.message}</div>)}
          </div>
        </div>
      </div>
    </div>
  );
}

const root = createRoot(document.getElementById('root'));
root.render(<TradingDashboard />);
</script>
</body>
</html>
